<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatiotemporal Dracula</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet Timeline CSS -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/leaflet-timeline-slider@1.0.1/src/leaflet.timelineSlider.min.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }

        header {
            background-color: #2d0a0a;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #8b0000;
        }

        h1 {
            color: #c41e3a;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            color: #a0a0a0;
            margin-top: 5px;
        }

        #map-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }

        #map {
            flex: 1;
            min-height: 400px;
        }

        #content-panel {
            background-color: #2a2a2a;
            padding: 20px;
            border-top: 2px solid #8b0000;
            max-height: 200px;
            overflow-y: auto;
        }

        #content-panel h3 {
            color: #c41e3a;
            margin-bottom: 10px;
        }

        #content-text {
            line-height: 1.6;
            color: #d0d0d0;
        }

        .leaflet-popup-content-wrapper {
            background-color: #2d0a0a;
            color: #f0f0f0;
            border: 2px solid #8b0000;
        }

        .leaflet-popup-tip {
            background-color: #2d0a0a;
        }

        .leaflet-popup-content {
            margin: 15px;
        }

        .popup-title {
            font-weight: bold;
            color: #c41e3a;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .popup-date {
            color: #a0a0a0;
            font-style: italic;
            margin-bottom: 10px;
        }

        .popup-content {
            color: #d0d0d0;
            line-height: 1.5;
        }

        /* Timeline slider styling */
        .time-slider-container {
            background-color: #2a2a2a;
            padding: 15px 20px;
            border-top: 2px solid #8b0000;
        }

        .time-slider-label {
            color: #c41e3a;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        #time-slider {
            width: 100%;
            cursor: pointer;
        }

        .time-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .time-controls button {
            background-color: #8b0000;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-family: inherit;
        }

        .time-controls button:hover {
            background-color: #c41e3a;
        }

        .time-controls button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #current-date {
            color: #f0f0f0;
            font-size: 1.1em;
        }

        .instructions {
            background-color: #333;
            padding: 10px 20px;
            color: #a0a0a0;
            font-size: 0.9em;
            text-align: center;
        }
    </style>
</head>

<body>
    <header>
        <h1>ü¶á Spatiotemporal Dracula ü¶á</h1>
        <p class="subtitle">Journey through the locations and events of Bram Stoker's Dracula</p>
    </header>

    <div class="instructions">
        Use the timeline slider or next/previous buttons below the map to step through events.
    </div>

    <div id="map-container">
        <div id="map"></div>

        <div class="time-slider-container">
            <label class="time-slider-label">Timeline Navigation</label>
            <input type="range" id="time-slider" min="0" max="100" value="0" />
            <div class="time-controls">
                <button id="prev-btn">‚Üê Previous</button>
                <button id="play-btn">‚ñ∂ Play</button>
                <button id="next-btn">Next ‚Üí</button>
                <span id="current-date">Select an event</span>
            </div>
        </div>

        <div id="content-panel">
            <h3>üìú Event Details</h3>
            <p id="content-text">Use the timeline slider or click on a marker to view event content.</p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Initialize the map centered on Europe
        const map = L.map('map').setView([48.0, 15.0], 4);

        // Add dark-themed tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Custom marker icon
        const draculaIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background-color: #8b0000; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #c41e3a; box-shadow: 0 0 10px rgba(139, 0, 0, 0.8);"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });

        const activeIcon = L.divIcon({
            className: 'custom-marker-active',
            html: '<div style="background-color: #c41e3a; width: 18px; height: 18px; border-radius: 50%; border: 3px solid #ff6b6b; box-shadow: 0 0 20px rgba(196, 30, 58, 1);"></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // Store markers and features
        let markers = [];
        let features = [];
        let currentIndex = 0;
        let isPlaying = false;
        let playInterval = null;

        // Helper function to get display title from feature properties
        function getTitle(props) {
            // Check for non-empty chapter_title first
            if (props.chapter_title && props.chapter_title.trim()) {
                return props.chapter_title;
            }
            // Use entry_type and author combination
            if (props.entry_type && props.author) {
                return `${props.entry_type} - ${props.author}`;
            }
            if (props.entry_type) {
                return props.entry_type;
            }
            return `Entry ${props.sequence_in_book || props.entry_id || ''}`;
        }

        // Helper function to get display date from feature properties
        function getDate(props) {
            return props.date_normalized || props.date_raw || '';
        }

        // Helper function to truncate content for popup
        function truncateContent(content, maxLength = 300) {
            if (!content) return '';
            if (content.length <= maxLength) return content;
            return content.substring(0, maxLength) + '...';
        }

        // Load GeoJSON data from external file
        fetch('data/dracula_part1.geojson')
            .then(response => response.json())
            .then(data => {
                // Sort features by sequence_in_book
                features = [...data.features].sort((a, b) =>
                    (a.properties.sequence_in_book || 0) - (b.properties.sequence_in_book || 0)
                );

                // Create markers for all features
                features.forEach((feature, index) => {
                    const coords = feature.geometry.coordinates;
                    const props = feature.properties;

                    const marker = L.marker([coords[1], coords[0]], { icon: draculaIcon }).addTo(map);

                    const popupContent = `
                        <div class="popup-title">${getTitle(props)}</div>
                        <div class="popup-date">${getDate(props)}</div>
                        <div class="popup-content">${truncateContent(props.content)}</div>
                    `;

                    marker.bindPopup(popupContent, { maxWidth: 350 });

                    marker.on('click', () => {
                        currentIndex = index;
                        updateTimelineUI();
                        displayContent(feature);
                    });

                    markers.push(marker);
                });

                // Set up the timeline slider
                const slider = document.getElementById('time-slider');
                slider.max = features.length - 1;

                // Initialize with first feature
                updateTimelineUI();
                displayContent(features[0]);
            })
            .catch(error => {
                console.error('Error loading GeoJSON:', error);
                document.getElementById('content-text').textContent = 'Error loading data. Please try again later.';
            });

        // Set up event listeners
        const slider = document.getElementById('time-slider');

        slider.addEventListener('input', (e) => {
            currentIndex = parseInt(e.target.value);
            updateTimelineUI();
            if (features[currentIndex]) {
                displayContent(features[currentIndex]);
            }
        });

        // Navigation buttons
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateTimelineUI();
                displayContent(features[currentIndex]);
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentIndex < features.length - 1) {
                currentIndex++;
                updateTimelineUI();
                displayContent(features[currentIndex]);
            }
        });

        document.getElementById('play-btn').addEventListener('click', () => {
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        });

        function startPlayback() {
            isPlaying = true;
            document.getElementById('play-btn').textContent = '‚è∏ Pause';
            playInterval = setInterval(() => {
                if (currentIndex < features.length - 1) {
                    currentIndex++;
                    updateTimelineUI();
                    displayContent(features[currentIndex]);
                } else {
                    stopPlayback();
                }
            }, 3000);
        }

        function stopPlayback() {
            isPlaying = false;
            document.getElementById('play-btn').textContent = '‚ñ∂ Play';
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        function updateTimelineUI() {
            if (features.length === 0) return;

            slider.value = currentIndex;

            // Update button states
            document.getElementById('prev-btn').disabled = currentIndex === 0;
            document.getElementById('next-btn').disabled = currentIndex === features.length - 1;

            // Update marker icons
            markers.forEach((marker, index) => {
                if (index === currentIndex) {
                    marker.setIcon(activeIcon);
                } else {
                    marker.setIcon(draculaIcon);
                }
            });

            // Pan to current marker
            const coords = features[currentIndex].geometry.coordinates;
            map.flyTo([coords[1], coords[0]], 6, { duration: 1 });
        }

        function displayContent(feature) {
            const props = feature.properties;
            const title = getTitle(props);
            const date = getDate(props);

            document.getElementById('current-date').textContent = date ? `${date} - ${title}` : title;
            document.getElementById('content-text').textContent = props.content || 'No content available.';

            // Open popup on the marker
            if (markers[currentIndex]) {
                markers[currentIndex].openPopup();
            }
        }
    </script>
</body>

</html>